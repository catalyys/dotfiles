---
- hosts: localhost
  vars_files:
    - vars.yml

  tasks:
    - name: install packages
      become: true
      ansible.builtin.package:
        name: "{{ packages }}"
        state: latest

    - name: enable services
      become: true
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        enabled: true
      loop: "{{ enabled_services }}"

    - name: Check if yay is already installed
      command: which yay
      register: yay_installed
      ignore_errors: yes
      changed_when: false

    - name: Debug yay installation status
      debug:
        msg: "yay is already installed"
      when: yay_installed.rc == 0

    - block:
        - name: Create temporary directory for yay installation
          file:
            path: "/tmp/yay"
            state: directory
            mode: "0755"

        - name: Clone yay repository
          git:
            repo: https://aur.archlinux.org/yay.git
            dest: "/tmp/yay"
            clone: yes
            update: no

        - name: Build and install yay
          command: makepkg -si --noconfirm
          args:
            chdir: "/tmp/yay"
          environment:
            MAKEFLAGS: "-j$(nproc)"

        - name: Verify yay installation
          command: yay --version
          register: yay_version_check
          changed_when: false
          failed_when: yay_version_check.rc != 0
      when: yay_installed.rc != 0

    - name: Install each AUR package individually
      command: yay -S --noconfirm --needed {{ item }}
      loop: "{{ aur_packages }}"
      register: yay_install
      changed_when: "'there is nothing to do' not in yay_install.stdout"

    - name: debug
      debug:
        msg: "/run/user/{{ ansible_effective_user_id }}"

    - name: enable hyprland-autoname-workspaces
      ansible.builtin.systemd_service:
        name: hyprland-autoname-workspaces
        state: started
        enabled: true
        scope: user
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ ansible_effective_user_id }}"

    - name: create nfs dir
      become: true
      file:
        path: "/mnt/nfs"
        state: directory
        mode: "0777"

    - name: create nfs dir
      become: true
      file:
        path: "/mnt/nfs/{{ item }}"
        state: directory
        mode: "0777"
        owner: 1000
        group: 1000
      loop: "{{ nfs_shares }}"

    - name: fstab
      become: true
      ansible.posix.mount:
        src: "10.11.13.22:/mnt/user/{{ item }}"
        path: "/mnt/nfs/{{ item }}"
        opts: defaults,user,noauto,relatime,rw
        state: mounted
        fstype: nfs
      loop: "{{ nfs_shares }}"
      ignore_errors: yes
